<?php require_once __DIR__.'/inc/db.php';
require __DIR__ . '/inc/config.php';

function loadTranslations(string $lang): array {
    $file = __DIR__ . "/lang/{$lang}.php";
    return is_file($file) ? (include $file) : [];
}

$T  = loadTranslations(APP_LANG);
$EN = loadTranslations('en'); // Fallback

function t(string $key, array $vars = []): string {
    global $T, $EN;
    $text = $T[$key] ?? $EN[$key] ?? $key; // Fallback auf EN oder Key
    foreach ($vars as $k => $v) {
        $text = str_replace('{' . $k . '}', (string)$v, $text);
    }
    return $text;
}

// Für sichere HTML-Ausgabe:
function th(string $key, array $vars = []): string {
    return htmlspecialchars(t($key, $vars), ENT_QUOTES, 'UTF-8');
}
?>
<!doctype html><html><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/><title>PenguinPVDash – Stats</title><link rel='stylesheet' href='assets/style.css'/><style>.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}.controls .group{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:10px}.controls label{font-size:12px;color:#cfe1ff;margin-right:6px}.controls select,.controls input{background:#0f1630;color:#eaf2ff;border:1px solid var(--border);border-radius:8px;padding:6px 8px}.stats-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}</style></head><body><div class='wrap'><div class='card'><div class='stats-header'><h1>Stats</h1><a href='./' class='badge'>Zurück</a></div><div class='controls'><div class='group'><label>Gerät</label><input id='device' value='home'/></div><div class='group'><label>Modus</label><select id='mode'><option value='year'>Jahr</option><option value='month'>Monat</option><option value='week'>Woche</option><option value='range'>Bereich</option></select></div><div class='group'><label>Jahr</label><select id='year'></select></div><div class='group' id='month-group'><label>Monat</label><select id='month'><option value='1'>Jan</option><option value='2'>Feb</option><option value='3'>Mär</option><option value='4'>Apr</option><option value='5'>Mai</option><option value='6'>Jun</option><option value='7'>Jul</option><option value='8'>Aug</option><option value='9'>Sep</option><option value='10'>Okt</option><option value='11'>Nov</option><option value='12'>Dez</option></select></div><div class='group' id='week-group'><label>ISO-Woche</label><select id='week'></select></div><div class='group' id='range-group' style='display:none'><label>Von</label><input type='date' id='from'/><label>Bis</label><input type='date' id='to'/></div><div class='group'><button id='apply' class='badge'>Anwenden</button></div></div><div class='table-wrap'><table class='fancy'><thead><tr><th><?= th('t19') ?></th><th><?= th('t20') ?></th><th><?= th('t21') ?></th><th><?= th('t22') ?></th><th><?= th('t23') ?></th><th><?= th('t24') ?></th><th><?= th('t25') ?></th></tr></thead><tbody id='hist-tbody'></tbody></table></div></div></div><script>const tb=document.getElementById('hist-tbody');const yearSel=document.getElementById('year');const weekSel=document.getElementById('week');const monthSel=document.getElementById('month');const modeSel=document.getElementById('mode');const rangeGroup=document.getElementById('range-group');const monthGroup=document.getElementById('month-group');const weekGroup=document.getElementById('week-group');function fillYears(){const y=(new Date()).getFullYear();yearSel.innerHTML='';for(let i=0;i<15;i++){const o=document.createElement('option');o.value=String(y-i);o.textContent=String(y-i);yearSel.appendChild(o);}}function fillWeeks(){weekSel.innerHTML='';for(let i=1;i<=53;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);weekSel.appendChild(o);}}function toggleInputs(){const m=modeSel.value;rangeGroup.style.display=(m==='range')?'':'none';monthGroup.style.display=(m==='month')?'':'none';weekGroup.style.display=(m==='week')?'':'none';}modeSel.addEventListener('change',toggleInputs);function isoWeekStart(y,w){const s=new Date(Date.UTC(y,0,1+(w-1)*7));const d=s.getUTCDay()||7;const start=new Date(s);if(d<=4)start.setUTCDate(s.getUTCDate()-d+1);else start.setUTCDate(s.getUTCDate()+8-d);return start;}function fmtDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+dd;}async function loadRange(dev,start,end){const r=await fetch(`api/range.php?device=${encodeURIComponent(dev)}&start=${start}&end=${end}`);const j=await r.json();tb.innerHTML='';(j.items||[]).forEach(it=>{const tr=document.createElement('tr');function cell(v){const td=document.createElement('td');td.textContent=(v==null?'–':(Math.round(v*100)/100).toLocaleString('de-DE'));return td;}const d=document.createElement('td');d.textContent=it.day;tr.appendChild(d);['pv_kwh','feed_in_kwh','batt_in_kwh','batt_out_kwh','consumption_kwh','grid_import_kwh'].forEach(k=>tr.appendChild(cell(it[k])));tb.appendChild(tr);});}document.getElementById('apply').addEventListener('click',()=>{const dev=document.getElementById('device').value||'home';const y=parseInt(yearSel.value,10);const m=parseInt(monthSel.value,10);const w=parseInt(weekSel.value,10);const mode=modeSel.value;let start,end;if(mode==='year'){start=fmtDate(new Date(y,0,1));end=fmtDate(new Date(y,11,31));}else if(mode==='month'){start=fmtDate(new Date(y,m-1,1));end=fmtDate(new Date(y,m,0));}else if(mode==='week'){const s=isoWeekStart(y,w);const e=new Date(s);e.setUTCDate(s.getUTCDate()+6);start=fmtDate(new Date(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()));end=fmtDate(new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()));}else{start=document.getElementById('from').value;end=document.getElementById('to').value;if(!start||!end)return;}loadRange(dev,start,end);});fillYears();fillWeeks();toggleInputs();document.getElementById('apply').click();</script></body></html>
